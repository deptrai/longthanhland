# Story 8.5.4: Display AI Summary on Listings

Status: drafted

## Story
As a buyer, I want to see AI-generated summary on listing pages, so that I can quickly understand key insights.

## Acceptance Criteria

1. **AI Summary Section Display**
   - Given AI summary generated (Story 8.5.1)
   - When I view listing detail page
   - Then I see AI summary section with:
     - Section header with sparkle icon (✨) and "AI Insights" label
     - **Property Highlights**: 3-5 key features (bullet points)
     - **Neighborhood Analysis**: Location insights (paragraph)
     - **Investment Potential**: Market analysis (paragraph)
     - **Suitable Buyer Profile**: Target buyer description (paragraph)
   - And section positioned prominently (after main description)
   - And distinct visual design (different background, border)

2. **AI-Generated Label**
   - Given summary displayed
   - When rendered
   - Then clearly labeled as "AI-Generated Content"
   - And includes disclaimer: "This summary was generated by AI. Please verify information independently."
   - And disclaimer visible but not intrusive

3. **Rich Text Rendering**
   - Given summary in HTML format
   - When rendered
   - Then displays:
     - Bold text (`<strong>`, `<b>`)
     - Bullet lists (`<ul>`, `<li>`)
     - Headings (`<h3>`, `<h4>`)
     - Paragraphs (`<p>`)
   - And preserves formatting from OpenAI response

4. **Unavailable Summary Handling**
   - Given summary not generated yet
   - When listing viewed
   - Then AI summary section hidden
   - And no placeholder shown

5. **Loading State**
   - Given summary being generated
   - When listing viewed during generation
   - Then skeleton loader displayed
   - And "Generating AI insights..." message shown
   - And loader replaced with content when ready

6. **Responsive Design**
   - Given various screen sizes
   - When summary displayed
   - Then responsive layout:
     - Mobile: Single column, stacked sections
     - Tablet: Single column with padding
     - Desktop: Full width with margins
   - And readable on all devices

## Tasks / Subtasks

- [ ] **Task 1: Create AISummaryPanel Component** (AC: #1, #2)
  - [ ] Create panel component:
    ```typescript
    const AISummaryPanel = ({ listing }: { listing: PublicListing }) => {
      if (!listing.aiSummary) return null;

      return (
        <div className="ai-summary-panel bg-gradient-to-br from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 mt-6">
          {/* Header */}
          <div className="header flex items-center gap-2 mb-4">
            <SparklesIcon className="w-6 h-6 text-purple-600" />
            <h2 className="text-2xl font-bold text-gray-900">AI Insights</h2>
            <span className="ml-auto text-xs text-gray-500 bg-white px-2 py-1 rounded">
              AI-Generated
            </span>
          </div>

          {/* Summary Content */}
          <div className="summary-content">
            <RichTextRenderer content={listing.aiSummary} />
          </div>

          {/* Disclaimer */}
          <div className="disclaimer mt-4 p-3 bg-white/50 rounded border border-purple-100">
            <div className="flex items-start gap-2 text-xs text-gray-600">
              <InfoIcon className="w-4 h-4 mt-0.5 flex-shrink-0" />
              <span>
                This summary was generated by AI. Please verify information independently.
              </span>
            </div>
          </div>
        </div>
      );
    };
    ```

- [ ] **Task 2: Create RichTextRenderer Component** (AC: #3)
  - [ ] Render HTML safely:
    ```typescript
    const RichTextRenderer = ({ content }: { content: string }) => {
      // Sanitize HTML to prevent XSS
      const sanitizedContent = DOMPurify.sanitize(content, {
        ALLOWED_TAGS: ['h3', 'h4', 'p', 'ul', 'li', 'strong', 'b', 'em', 'i'],
        ALLOWED_ATTR: [],
      });

      return (
        <div
          className="rich-text-content prose prose-purple max-w-none"
          dangerouslySetInnerHTML={{ __html: sanitizedContent }}
        />
      );
    };
    ```
  - [ ] Add CSS for rich text:
    ```css
    .rich-text-content h3 {
      @apply text-lg font-semibold text-gray-900 mt-4 mb-2;
    }

    .rich-text-content p {
      @apply text-gray-700 mb-3 leading-relaxed;
    }

    .rich-text-content ul {
      @apply list-disc list-inside mb-3 space-y-1;
    }

    .rich-text-content li {
      @apply text-gray-700;
    }

    .rich-text-content strong,
    .rich-text-content b {
      @apply font-semibold text-gray-900;
    }
    ```

- [ ] **Task 3: Create Loading State Component** (AC: #5)
  - [ ] Skeleton loader:
    ```typescript
    const AISummaryLoading = () => {
      return (
        <div className="ai-summary-panel bg-gradient-to-br from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 mt-6">
          <div className="header flex items-center gap-2 mb-4">
            <SparklesIcon className="w-6 h-6 text-purple-600 animate-pulse" />
            <div className="h-8 w-32 bg-purple-200 rounded animate-pulse" />
          </div>

          <div className="space-y-3">
            <div className="h-4 bg-purple-100 rounded w-3/4 animate-pulse" />
            <div className="h-4 bg-purple-100 rounded w-full animate-pulse" />
            <div className="h-4 bg-purple-100 rounded w-5/6 animate-pulse" />
            <div className="h-4 bg-purple-100 rounded w-2/3 animate-pulse" />
          </div>

          <div className="mt-4 flex items-center gap-2 text-sm text-purple-600">
            <LoaderIcon className="w-4 h-4 animate-spin" />
            <span>Generating AI insights...</span>
          </div>
        </div>
      );
    };
    ```

- [ ] **Task 4: Integrate into Listing Detail Page** (AC: #1, #4, #5)
  - [ ] Add to listing page:
    ```typescript
    const ListingDetailPage = ({ listing }: { listing: PublicListing }) => {
      const [summaryGenerating, setSummaryGenerating] = useState(false);

      // Check if summary is being generated
      useEffect(() => {
        if (!listing.aiSummary && listing.status === 'APPROVED') {
          setSummaryGenerating(true);

          // Poll for summary completion
          const interval = setInterval(async () => {
            const updated = await refetchListing(listing.id);
            if (updated.aiSummary) {
              setSummaryGenerating(false);
              clearInterval(interval);
            }
          }, 5000); // Check every 5 seconds

          // Stop polling after 2 minutes
          setTimeout(() => {
            setSummaryGenerating(false);
            clearInterval(interval);
          }, 120000);

          return () => clearInterval(interval);
        }
      }, [listing]);

      return (
        <div className="listing-detail">
          {/* Existing content */}
          <div className="listing-header">
            <h1>{listing.title}</h1>
            <div className="price">{formatPrice(listing.price)} VNĐ</div>
          </div>

          {/* Main description */}
          <div className="description">
            {listing.description}
          </div>

          {/* AI Summary Section */}
          {summaryGenerating ? (
            <AISummaryLoading />
          ) : listing.aiSummary ? (
            <AISummaryPanel listing={listing} />
          ) : null}

          {/* Rest of content */}
        </div>
      );
    };
    ```

- [ ] **Task 5: Add Responsive Styles** (AC: #6)
  - [ ] Mobile-first responsive design:
    ```css
    .ai-summary-panel {
      /* Mobile (default) */
      @apply p-4;
    }

    @media (min-width: 640px) {
      /* Tablet */
      .ai-summary-panel {
        @apply p-5;
      }
    }

    @media (min-width: 1024px) {
      /* Desktop */
      .ai-summary-panel {
        @apply p-6 max-w-4xl mx-auto;
      }
    }

    .rich-text-content {
      /* Mobile */
      @apply text-sm;
    }

    @media (min-width: 640px) {
      /* Tablet & Desktop */
      .rich-text-content {
        @apply text-base;
      }
    }
    ```

- [ ] **Task 6: Add GraphQL Query** (AC: #1)
  - [ ] Query for AI summary:
    ```typescript
    const GET_LISTING_WITH_SUMMARY = gql`
      query GetListingWithSummary($id: ID!) {
        publicListing(id: $id) {
          id
          title
          description
          price
          aiSummary
          aiSummaryGeneratedAt
          status
          # ... other fields
        }
      }
    `;
    ```

- [ ] **Task 7: Add Analytics Tracking** (AC: #1)
  - [ ] Track summary views:
    ```typescript
    useEffect(() => {
      if (listing.aiSummary) {
        // Track AI summary view
        analytics.track('AI Summary Viewed', {
          listingId: listing.id,
          summaryLength: listing.aiSummary.length,
          generatedAt: listing.aiSummaryGeneratedAt,
        });
      }
    }, [listing.aiSummary]);
    ```

- [ ] **Task 8: Create Unit Tests**
  - [ ] Test AISummaryPanel rendering
  - [ ] Test RichTextRenderer with various HTML
  - [ ] Test loading state
  - [ ] Test unavailable handling
  - [ ] Achieve >80% coverage

- [ ] **Task 9: Integration Testing**
  - [ ] Test complete display flow
  - [ ] Test with/without summary
  - [ ] Test loading state transitions
  - [ ] Test responsive design

- [ ] **Task 10: Manual Testing**
  - [ ] View listing with AI summary
  - [ ] View listing without AI summary
  - [ ] Test loading state
  - [ ] Test on mobile device
  - [ ] Verify rich text formatting
  - [ ] Verify disclaimer visibility

## Dev Notes

### Architecture Context

**AI Summary Display**: User-facing visualization
- Displays AI-generated property summary
- 4-section format (highlights, neighborhood, investment, buyer profile)
- Rich text rendering with HTML
- Loading state during generation
- Responsive design (mobile-first)
- Clear AI labeling and disclaimer

**Key Design Decisions**:
- Distinct visual design (purple gradient background)
- Sparkle icon (✨) for AI branding
- Positioned after main description
- Hidden if unavailable (no placeholder)
- Loading state with polling (5s interval)
- Sanitized HTML rendering (XSS prevention)

### Implementation Details

**Visual Design**:
- Background: Purple-to-blue gradient
- Border: Purple 200
- Icon: Sparkles (purple 600)
- AI label: Small badge in header
- Disclaimer: White background with info icon

**Rich Text Rendering**:
- Allowed tags: h3, h4, p, ul, li, strong, b, em, i
- DOMPurify for XSS prevention
- Tailwind prose classes for styling

**Loading State**:
- Skeleton loader with pulse animation
- "Generating AI insights..." message
- Polling every 5 seconds
- Max 2 minutes timeout

**Responsive Breakpoints**:
- Mobile: < 640px (padding 4)
- Tablet: 640px - 1024px (padding 5)
- Desktop: > 1024px (padding 6, max-width 4xl)

### Testing Strategy

**Unit Tests**: Component rendering, HTML sanitization, loading state
**Integration Tests**: Complete flow, polling, responsive design
**Manual Tests**: UI/UX verification, mobile testing

### References

- [Epic 8.5](../real-estate-platform/epics.md#story-854-display-ai-summary-on-listings)
- [PRD v1.4](../real-estate-platform/prd-v1.3.md) - Section 4.8.5
- [Story 8.5.1](./8-5-1-openai-integration-ai-summary.md) - AI Summary Generation

### Success Criteria

**Definition of Done**:
- ✅ AI summary panel component created
- ✅ Rich text rendering working
- ✅ AI labeling and disclaimer displayed
- ✅ Loading state implemented
- ✅ Unavailable handling working
- ✅ Responsive design implemented
- ✅ HTML sanitization working (XSS prevention)
- ✅ Analytics tracking implemented
- ✅ Unit tests pass (>80% coverage)
- ✅ Integration tests pass
- ✅ Manual testing successful

**Estimate**: 4 hours

## Dev Agent Record

### Context Reference
<!-- Story context XML will be added by story-context workflow -->

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent during implementation -->

### Completion Notes List
<!-- To be filled by dev agent after completion -->

### File List
<!-- To be filled by dev agent with NEW/MODIFIED/DELETED files -->
